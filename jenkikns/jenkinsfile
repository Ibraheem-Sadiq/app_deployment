pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                dir('./app_deployment/K8S'){}
                sh  '''
                    git clone https://github.com/Ibraheem-Sadiq/ecommerce.git
                    docker build -t ibrahim0sadek/ecommerce/frontend:$BUILD_NUMBER ./server/.
                    docker build -t ibrahim0sadek/ecommerce/backend:$BUILD_NUMBER  ./client/.
                '''
            }
        }

        stage('Push') {
            
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'docker_hub', passwordVariable: 'DOCKER_REGISTRY_PWD', usernameVariable: 'DOCKER_REGISTRY_USER')
                    ]) {
                        sh  '''
                            echo   docker login -u ibrahim0sadek
                            docker push ibrahim0sadek/e_commerce:frontend:$BUILD_NUMBER
                            docker push ibrahim0sadek/e_commerce:backend:$BUILD_NUMBER
                        '''
                    } 
            }
        }
        stage('Test') {
            steps {
                echo 'Testing..'
            }
        }
        stage('notify argocd by updating version') {
            steps {
                withCredentials([
                    gitUsernamePassword(credentialsId: 'dep_rep', gitToolName: 'Default')
                ]) 
                    {
                    sh    
                    '''
                        git clone https://github.com/Ibraheem-Sadiq/app_deployment.git/
                        cd app_deployment/K8S
                        sed -i -E "s/image:(.*)[0-9]+/image: ibrahim0sadek/e_commerce/server:$BUILD_NUMBER/" backEnd.yaml
                        sed -i -E "s/image:(.*)[0-9]+/image: ibrahim0sadek/e_commerce/client:$BUILD_NUMBER/" frontEnd.yaml
                        git config --global user.name "ibrahim sadek"
                        git config --global user.email "ibrahim2506950@gmail.com"
                        git commit -m "version update v($BUILD_NUMBER)"
                        git push
                    '''
                    }
            }
    }
    }


}
